---
title: "Quantifying Geometric Change in an Isotopy"
format: 
    html:
        page-layout: full
---


### Isotopy

Here we view an isotopy; a continuous deformation through time $f_t: T^2 \to T^2$, where each step is a homeomorphism.  The topology remains the same but the geometry changes.   One aspect of this change is the **metric distortion** â€” how much the surface area of small neighborhoods stretches or shrinks during the transformation.  This is indicated by the color of the faces in the 3D model, where blue indicates shrinking and red indicates stretching.  The histogram on the right quantifies this distortion across all faces, showing the distribution of area change.

::: {layout="[60, 40]"}
::: {#first-column}

<div style="background: #fdfdfd; padding: 10px; border-radius: 8px; border: 1px solid #eee;">
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

<model-viewer 
    id="torus-scrubber" 
    src="../assets/torus_area_analysis/step_0.glb"
    camera-controls 
    style="width: 100%; height: 400px;">
</model-viewer>

<input type="range" id="master-slider" min="0" max="19" value="0" style="width: 100%;">
<p><strong>Slide to evolve Homeomorphism:</strong> <span id="frame-val">0</span></p>
</div>

:::
::: {#second-column}

### Geometric Distortion
The histogram below represents the distribution of area change across all faces. A "perfect" area-preserving map would result in a single spike at **1.0**.

<div style="flex: 1; min-width: 300px; text-align: center;">
  <img id="hist-scrubber" src="../dist_hist/histogram_0.png" style="width: 100%; max-width: 450px; border-radius: 8px;">
</div>
:::
:::

### Analysis of the Mapping
<style>
  .stats-container {
    display: flex;
    justify-content: space-around;
    background: #2c3e50;
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 10px 0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .stat-box {
    text-align: center;
  }
  .stat-label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.8;
  }
  .stat-value {
    display: block;
    font-size: 1.4rem;
    font-weight: bold;
    font-family: 'Courier New', Courier, monospace;
    color: #3498db; /* A nice highlight blue */
  }
  #max-val { color: #e74c3c; } /* Red for Max stretch */
  #min-val { color: #f1c40f; } /* Yellow for Min squeeze */
</style>

```{=html}
<div class="stats-container">
<div class="stat-box">
    <span class="stat-label">Min Ratio</span>
    <span id="min-val" class="stat-value">1.000</span>
</div>
<div class="stat-box">
    <span class="stat-label">Mean Ratio</span>
    <span id="mean-val" class="stat-value">1.000</span>
</div>
<div class="stat-box">
    <span class="stat-label">Max Ratio</span>
    <span id="max-val" class="stat-value">1.000</span>
</div>
</div>
```

```{r, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
library(tidyverse)
library(jsonlite)

orig_areas <- read_csv('dist_hist/og_areas.csv') |> janitor::clean_names()
face_data <- read_csv("dist_hist/ratios.csv") |> janitor::clean_names()

# Calculate stats for all columns
dist_stats <- face_data |> 
  summarise(across(
    everything(), 
    list(
      mean = \(x) mean(x, na.rm = TRUE),
      max  = \(x) max(x, na.rm = TRUE),
      min  = \(x) min(x, na.rm = TRUE)
    ),
    .names = "{.col}_{.fn}" # Creates names like "step_0_max"
  ))

# Pivot to make it readable (Long format)
dist_stats_tidy <- dist_stats |> 
  pivot_longer(
    everything(), 
    names_to = c("frame", "stat"), 
    names_pattern = "(.*)_(.*)"
  ) |> 
  pivot_wider(names_from = stat, values_from = value)

# Convert the tidy table to a JSON object where 'frame' is the key
stats_json <- jsonlite::toJSON(dist_stats_tidy)
cat(paste0("<script>var frameStats = ", stats_json, ";</script>"))
```

<script>
    const viewer = document.querySelector('#torus-scrubber');
    const histImg = document.querySelector('#hist-scrubber');
    const slider = document.querySelector('#master-slider');
    const label = document.querySelector('#frame-val');

    slider.addEventListener('input', (e) => {
        const val = e.target.value;
        
        // Update 3D Model
        viewer.src = `../assets/torus_area_analysis/step_${val}.glb`;
        
        // Update Histogram Image
        histImg.src = `../dist_hist/histogram_${val}.png`;
        
        // Update label
        label.innerText = val;

        // Access the stats for the current frame
        document.querySelector('#max-val').innerText  = frameStats[val].max.toFixed(3);
        document.querySelector('#mean-val').innerText = frameStats[val].mean.toFixed(3);
        document.querySelector('#min-val').innerText  = frameStats[val].min.toFixed(3);
    });
</script>


